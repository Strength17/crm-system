<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{% block title %}CRM System{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    {% block extra_head %}
    <style>
        [x-cloak] { display: none !important; }
    </style>
    {% endblock %}
</head>
<body class="bg-gray-50" x-data="layoutData()" x-init="init()">
    <div {% block root_attributes %}{% endblock %}>
        <!-- Mobile sidebar backdrop -->
        <div x-show="sidebarOpen" 
             @click="sidebarOpen = false"
             x-transition:enter="transition-opacity ease-linear duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition-opacity ease-linear duration-300"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-gray-900/80 lg:hidden z-40"
             x-cloak></div>

        <!-- Sidebar -->
        <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'" 
               class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transition-transform duration-300 ease-in-out lg:translate-x-0">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <a href="{{url_for('auth.index')}}">
                    <div class="flex items-center h-16 px-6 border-b border-gray-200">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="w-9 h-13 " />
                        <h1 class="ml-3 font-bold text-gray-900">CRM System</h1>
                    </div>
                </a>

                <!-- Navigation -->
                <nav class="flex-1 px-4 py-4 space-y-4 overflow-y-auto flex flex-col justify-between h-full">
                    <!-- Top section: Add Business button -->
                    <div class="mb-4">
                        <a href="{{url_for('crm.add_business')}}" 
                        class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add Business
                        </a>
                    </div>

                    <!-- Middle section: Table links with conditional active classes -->
                    <div class="flex-1 space-y-4">
                        <a href="{{url_for('crm.dashboard')}}" 
                           class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors {% if active_page=='dashboard' %}bg-blue-100 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            <!-- icon and text -->
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                            </svg>
                            Dashboard
                        </a>
                        <a href="{{url_for('crm.prospects_page')}}" 
                           class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors {% if active_page=='prospects' %}bg-blue-100 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            <!-- icon and text -->
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Prospect
                        </a>
                        <a href="{{url_for('crm.interactions_page')}}" 
                           class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors {% if active_page=='interactions' %}bg-blue-100 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            <!-- icon and text -->
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                            </svg>
                            Interactions
                        </a>
                        <a href="{{url_for('crm.deals_page')}}" 
                           class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors {% if active_page=='deals' %}bg-blue-100 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            <!-- icon and text -->
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Deals
                        </a>
                        <a href="{{url_for('crm.payments_page')}}" 
                           class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors {% if active_page=='payments' %}bg-blue-100 text-blue-700{% else %}text-gray-700 hover:bg-gray-50{% endif %}">
                            <!-- icon and text -->
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                            </svg>
                            Payments
                        </a>
                    </div>

                    <!-- Bottom section: Logout link -->
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <button id="logoutBtn" class="flex items-center px-4 py-2.5 text-sm font-medium rounded-lg transition-colors text-red-600 hover:bg-gray-50 w-full justify-start">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7"/>
                        </svg>
                        Logout
                        </button>
                    </div>
                </nav>
            </div>
        </aside>

        <!-- Main content -->
        <div class="lg:pl-64">
            <!-- Header -->
            <header class="sticky top-0 z-30 bg-white border-b border-gray-200">
                <div class="flex items-center justify-between h-16 px-4 sm:px-6 lg:px-8">
                    <button @click="sidebarOpen = !sidebarOpen" 
                            class="text-gray-500 hover:text-gray-600 lg:hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <!-- User profile with icon, name, and email -->
                    <div class="flex items-center space-x-4 ml-auto">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                            </div>
                            <div class="text-left">
                                <div class="text-sm font-medium text-gray-900" x-text="$store.auth.user.name"></div>
                                <div class="text-xs text-gray-500" x-text="$store.auth.user.email"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Page content -->
             
             <div {% block x_data %}{% endblock %}>
                 {% block content %}{% endblock %}
             </div>
        </div>
    </div>

    {% block scripts %}{% endblock %}

<script>
document.addEventListener('alpine:init', () => {
  Alpine.store('auth', {
    user: { name: '', email: '' },
    async loadUser() {
      try {
        const res = await fetch('/auth/me');
        if (res.ok) {
          const data = await res.json();
          console.log('auth/me response:', data);
          // âœ… Assign correctly
          this.user = { name: data.name, email: data.email };
        }
      } catch (err) {
        console.error('Failed to load user:', err);
      }
    }
  });

  Alpine.store('auth').loadUser();
});


// Patch fetch globally to always include the token
const originalFetch = window.fetch;
window.fetch = async (url, options = {}) => {
  const token = localStorage.getItem('authToken');
  const headers = {
    ...options.headers,
    'Content-Type': 'application/json'
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  const response = await originalFetch(url, { ...options, headers });

  if (response.status === 401) {
    localStorage.removeItem('authToken');
    window.location.href = "/auth/login";
  }

  return response;
};
</script>


    <!-- Logout -->
    <script>
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = "/auth/login"; // adjust if needed
      });
      function layoutData() {
            return {
                sidebarOpen: false,
                user: { name: '', email: '' },

                toggleSidebar() {
                    this.sidebarOpen = !this.sidebarOpen
                },

                async init() {
                    try {
                        const res = await fetch("{{ url_for('crm.dashboard_data') }}");
                        const data = await res.json();
                        this.user = data.user || { name: '', email: '' };
                    } catch (e) {
                        console.error("Failed to load user", e);
                    }
                }
            }
        }

    </script>

    <script>
  // Global poller object
  window.GlobalPoller = {
    tasks: [],

    // Register a polling function with interval (ms)
    register(fn, interval = 15000) {
      this.tasks.push({ fn, interval, lastRun: 0 });
    },

    // Start polling all registered functions
    start() {
      const loop = () => {
        const now = Date.now();
        this.tasks.forEach(task => {
          if (now - task.lastRun >= task.interval) {
            task.fn();
            task.lastRun = now;
          }
        });
        requestAnimationFrame(loop);
      };
      loop();
    }
  };

  // Start polling immediately
  window.addEventListener('DOMContentLoaded', () => {
    window.GlobalPoller.start();
  });
</script>


</body>
</html>