{% extends "template.html" %}

{% block title %}CRM System — Prospects{% endblock %}

{% block x_data %}x-data="prospectsPage()" x-init="init()"{% endblock %}

{% block active_nav %}prospects{% endblock %}

{% block head_extra %}
  <style>
    .modal-scrollable::-webkit-scrollbar {
      width: 8px;
    }
    .modal-scrollable::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Modal for editing prospects -->
  <div x-show="showEditModal" class="fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center" x-cloak>
    <div class="bg-white rounded-lg max-w-xl w-full p-6">
      <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 pb-4">Edit Prospect</h3>
      <form @submit.prevent="saveProspect">
        <div class="modal-scrollable overflow-y-auto max-h-96 mb-6">
          <div class="space-y-4 pr-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input type="text" x-model="editProspectData.name" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" x-model="editProspectData.email" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
              <input type="text" x-model="editProspectData.phone" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
              <input type="text" x-model="editProspectData.website" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pain</label>
              <textarea x-model="editProspectData.pain" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Pain Score (0-10)</label>
              <input type="number" min="0" max="10" x-model.number="editProspectData.pain_score" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select x-model="editProspectData.status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="qualified">Qualified</option>
                <option value="not_qualified">Not Qualified</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
              </select>
            </div>
          </div>
        </div>
        <div class="flex justify-end space-x-2 border-t border-gray-200 pt-4">
          <button type="button" @click="closeEdit()" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <main class="p-4 sm:p-6 lg:p-8">
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Prospects</h2>
      <p class="mt-1 text-sm text-gray-600">Manage your prospect data</p>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center gap-2 text-sm text-gray-700">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
          <span x-text="`${filteredProspects().length} result(s)`"></span>
        </span>
        <span class="hidden sm:inline text-gray-300">|</span>
        <span class="text-xs text-gray-500">Last updated <span x-text="lastUpdated"></span></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="exportCSV" class="px-3 py-2 text-sm rounded-md bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v8M8 9l4 4 4-4"/><path d="M4 19h16"/>
          </svg>
          Export CSV
        </button>
        <button @click="clearFilters" class="px-3 py-2 text-sm rounded-md bg-gray-100 text-gray-800 hover:bg-gray-200 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Clear filters
        </button>
        <div class="flex items-center space-x-2 ml-4">
          <input type="text" placeholder="Filter by Prospect ID" x-model="filterIdValue" @input="onFilterChange()" class="border border-gray-300 rounded-md px-2 py-1 text-sm"/>
        </div>
      </div>
    </div>

    <!-- Separate toggles for created_at and updated_at instead of single "Show Dates" -->
    <div class="mb-4 flex items-center space-x-4">
      <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
        <input type="checkbox" x-model="showCreatedAt" @change="onFilterChange" class="accent-blue-600"/>
        <span>Show Created At</span>
      </label>
      <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
        <input type="checkbox" x-model="showUpdatedAt" @change="onFilterChange" class="accent-blue-600"/>
        <span>Show Updated At</span>
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select x-model="filterStatus" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="not_qualified">Not Qualified</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input type="text" placeholder="Filter by name" x-model="filterName" @input="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm"/>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input type="text" placeholder="Filter by email" x-model="filterEmail" @input="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm"/>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Website</label>
        <input type="text" placeholder="Filter by website" x-model="filterWebsite" @input="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm"/>
      </div>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('id')">
              Prospect ID <span x-show="sortBy==='id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('name')">
              Name <span x-show="sortBy==='name'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('email')">
              Email <span x-show="sortBy==='email'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('phone')">
              Phone <span x-show="sortBy==='phone'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('website')">
              Website <span x-show="sortBy==='website'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('pain_score')">
              Pain Score <span x-show="sortBy==='pain_score'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('status')">
              Status <span x-show="sortBy==='status'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('pain')">
              Pain <span x-show="sortBy==='pain'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <!-- Show created_at and updated_at columns separately based on their toggles -->
            <th x-show="showCreatedAt" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('created_at')">
              Created At <span x-show="sortBy==='created_at'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th x-show="showUpdatedAt" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('updated_at')">
              Updated At <span x-show="sortBy==='updated_at'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Actions
            </th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-200">
          <template x-if="pagedProspects().length === 0">
            <tr>
              <td colspan="12" class="px-6 py-10 text-center">
                <div class="flex flex-col items-center gap-3">
                  <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5z"/>
                    <path d="M4 20c0-4.4 3.6-8 8-8s8 3.6 8 8"/>
                  </svg>
                  <p class="text-sm text-gray-600">No prospects found</p>
                </div>
              </td>
            </tr>
          </template>

          <template x-for="prospect in pagedProspects()" :key="prospect.id">
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900" x-text="prospect.id"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="prospect.name"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="prospect.email"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="prospect.phone || '-'"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="prospect.website || '-'"></td>

              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                  :class="{
                    'text-green-700': prospect.pain_score <= 4,
                    'text-orange-700': prospect.pain_score >= 5 && prospect.pain_score <= 7,
                    'text-red-700': prospect.pain_score >= 8
                  }"
                  x-text="prospect.pain_score || '-'">
              </td>

              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                  :class="{
                    'text-blue-700': prospect.status==='new',
                    'text-purple-700': prospect.status==='contacted',
                    'text-indigo-700': prospect.status==='qualified',
                    'text-red-700': prospect.status==='not_qualified',
                    'text-green-700': prospect.status==='won',
                    'text-gray-700': prospect.status==='lost'
                  }"
                  x-text="prospect.status">
              </td>

              <!-- Added hover effect and modal for Pain field -->
              <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate" x-data="{ open: false }">
                <span
                  class="cursor-pointer"
                  :title="prospect.pain || '-'"
                  @click="open = true"
                  x-text="prospect.pain || '-'">
                </span>

                <!-- Modal for full pain text -->
                <div
                  x-show="open"
                  x-cloak
                  @click.away="open = false"
                  class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
                  <div class="bg-white rounded-lg max-w-md w-full p-4">
                    <h4 class="text-sm font-semibold text-gray-900 mb-2">Prospect Pain</h4>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="prospect.pain || '-'"></p>
                    <div class="mt-4 text-right">
                      <button
                        @click="open = false"
                        class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded">
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              </td>

              <td x-show="showCreatedAt" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="prospect.created_at"></td>
              <td x-show="showUpdatedAt" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="prospect.updated_at || '-'"></td>

              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <button class="px-3 py-1.5 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors"
                          @click="editProspect(prospect)">
                    Edit
                  </button>
                  <button class="px-3 py-1.5 text-xs rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition-colors"
                          @click="deleteProspect(prospect)">
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <div class="text-xs text-gray-500">
        Page
        <input type="number"
               x-model="pageInput"
               @keydown.enter="goToPage()"
               class="w-16 border border-gray-300 rounded px-2 py-1 text-center"/>
        of <span x-text="totalPages()"></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="page=page-1; pageInput=page+1" :disabled="page===0" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Previous</button>
        <button @click="page=page+1; pageInput=page+1" :disabled="page>=totalPages()-1" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Next</button>
      </div>
    </div>

    <!-- Success Dialog -->
    <div
      x-show="showSuccessDialog"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
    >
      <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <div class="flex-1">
            <h4 class="text-sm font-semibold text-gray-900" x-text="successTitle"></h4>
            <p class="mt-1 text-sm text-gray-600" x-text="successMessage"></p>
          </div>
        </div>

        <div class="mt-4 text-right">
          <button
            @click="closeSuccess()"
            class="px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700 transition"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- DELETE CONFIRMATION DIALOG -->
    <div
      x-show="showDeleteConfirm"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
    >
      <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
        <h4 class="text-sm font-semibold text-gray-900 mb-2">Confirm Delete</h4>
        <p class="text-sm text-gray-600 mb-4">
          Are you sure you want to delete this prospect?
        </p>
        <div class="flex justify-end gap-2">
          <button
            @click="cancelDelete()"
            class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300"
          >
            Cancel
          </button>
          <button
            @click="confirmDelete()"
            class="px-3 py-1.5 text-sm text-white bg-red-600 rounded hover:bg-red-700"
          >
            OK
          </button>
        </div>
      </div>
    </div>

  </main>

{% endblock %}

{% block scripts %}
<script>
function prospectsPage() {
  return {
    lastUpdated: 'just now',
    showEditModal: false,
    editProspectData: {},
    currentProspectId: null,
    showCreatedAt: false,
    showUpdatedAt: false,

    clearFilters() {
      this.filterIdValue = '';
      this.filterStatus = '';
      this.filterName = '';
      this.filterEmail = '';
      this.filterWebsite = '';
    },

    sortBy: 'id',
    sortDir: 'desc',

    page: 0,
    pageSize: 10,
    prospects: [],

    pageInput: null,

    /* SUCCESS DIALOG */
    showSuccessDialog: false,
    successMessage: '',
    successTitle: '',
    closeSuccess() { this.showSuccessDialog = false },

    /* DELETE CONFIRMATION */
    showDeleteConfirm: false,
    prospectToDelete: null,

    filterIdValue: '',
    filterStatus: '',
    filterName: '',
    filterEmail: '',
    filterWebsite: '',

    init() {
      this.fetchProspects();
      this.pageInput = this.page + 1;
      if (window.GlobalPoller) {
        window.GlobalPoller.register(() => this.fetchProspects(), 15000);
      } else {
        setInterval(() => this.fetchProspects(), 15000);
      }
    },

    async fetchProspects() {
      const res = await fetch(`/crm/prospects-data`);
      const data = await res.json();
      this.prospects = Array.isArray(data) ? data : [];

      this.lastUpdated = new Date().toLocaleTimeString();

      this.pageInput = this.page + 1;
    },

    toggleSort(field) {
      if (this.sortBy === field) {
        this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortBy = field;
        this.sortDir = 'desc';
      }
    },

    filteredProspects() {
      let arr = [...this.prospects];

      if (this.filterIdValue) {
        arr = arr.filter(p => String(p.id).includes(this.filterIdValue));
      }

      if (this.filterStatus) arr = arr.filter(p => p.status === this.filterStatus);
      if (this.filterName) arr = arr.filter(p => p.name && p.name.toLowerCase().includes(this.filterName.toLowerCase()));
      if (this.filterEmail) arr = arr.filter(p => p.email && p.email.toLowerCase().includes(this.filterEmail.toLowerCase()));
      if (this.filterWebsite) arr = arr.filter(p => p.website && p.website.toLowerCase().includes(this.filterWebsite.toLowerCase()));

      arr.sort((a, b) => {
        let av = a[this.sortBy];
        let bv = b[this.sortBy];
        if (av == null) av = '';
        if (bv == null) bv = '';
        if (typeof av === 'string') av = av.toLowerCase();
        if (typeof bv === 'string') bv = bv.toLowerCase();
        if (av < bv) return this.sortDir === 'asc' ? -1 : 1;
        if (av > bv) return this.sortDir === 'asc' ? 1 : -1;
        return 0;
      });

      return arr;
    },

    pagedProspects() {
      const filtered = this.filteredProspects();
      const start = this.page * this.pageSize;
      return filtered.slice(start, start + this.pageSize);
    },

    totalPages() {
      return Math.ceil(this.filteredProspects().length / this.pageSize);
    },

    goToPage() {
      const target = parseInt(this.pageInput, 10) - 1;
      if (target >= 0 && target < this.totalPages()) {
        this.page = target;
      }
    },

    onFilterChange() {
      this.page = 0;
      this.pageInput = 1;
    },

    editProspect(prospect) {
      this.currentProspectId = prospect.id;
      this.editProspectData = { ...prospect };
      this.showEditModal = true;
    },

    closeEdit() {
      this.showEditModal = false;
      this.editProspectData = {};
      this.currentProspectId = null;
    },

    async saveProspect() {
      try {
        const res = await fetch(`/crm/prospects/${this.currentProspectId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(this.editProspectData)
        });

        if (res.ok) {
          this.successTitle = 'Success!';
          this.successMessage = 'Prospect updated successfully.';
          this.showSuccessDialog = true;

          await this.fetchProspects();
          this.closeEdit();
        } else {
          alert('Failed to update prospect');
        }
      } catch (err) {
        console.error('Error updating prospect:', err);
      }
    },

    deleteProspect(prospect) {
      this.prospectToDelete = prospect;
      this.showDeleteConfirm = true;
    },

    cancelDelete() {
      this.showDeleteConfirm = false;
      this.prospectToDelete = null;
    },

    async confirmDelete() {
      if (!this.prospectToDelete) return;

      try {
        const res = await fetch(`/crm/prospects/${this.prospectToDelete.id}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          this.successTitle = 'Deleted!';
          this.successMessage = 'Prospect deleted successfully.';
          this.showSuccessDialog = true;

          await this.fetchProspects();
          this.showDeleteConfirm = false;
          this.prospectToDelete = null;
        } else {
          alert('Failed to delete prospect');
        }
      } catch (err) {
        console.error('Error deleting prospect:', err);
      }
    },

    exportCSV() {
      const rows = this.filteredProspects();
      if (rows.length === 0) {
        alert('No data to export');
        return;
      }

      const headers = ['ID', 'Name', 'Email', 'Phone', 'Website', 'Pain Score', 'Status', 'Pain', 'Created At', 'Updated At'];
      let csv = headers.join(',') + '\n';

      rows.forEach(row => {
        const values = [
          row.id,
          `"${(row.name || '').replace(/"/g, '""')}"`,
          `"${(row.email || '').replace(/"/g, '""')}"`,
          `"${(row.phone || '').replace(/"/g, '""')}"`,
          `"${(row.website || '').replace(/"/g, '""')}"`,
          row.pain_score || '',
          row.status || '',
          `"${(row.pain || '').replace(/"/g, '""')}"`,
          row.created_at || '',
          row.updated_at || ''
        ];
        csv += values.join(',') + '\n';
      });

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'prospects.csv';
      a.click();
      URL.revokeObjectURL(url);
    }
  }
}
</script>
{% endblock %}
