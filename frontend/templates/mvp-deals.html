{% extends "template.html" %}

{% block title %}CRM System — Deals{% endblock %}

{% block x_data %}x-data="dealsPage()" x-init="init()"{% endblock %}

{% block active_nav %}deals{% endblock %}

{% block head_extra %}
  <style>
    .modal-scrollable::-webkit-scrollbar {
      width: 8px;
    }
    .modal-scrollable::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Modal for editing deals -->
  <div x-show="showEditModal" class="fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center" x-cloak>
    <div class="bg-white rounded-lg max-w-xl w-full p-6">
      <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 pb-4">Edit Deal</h3>
      <form @submit.prevent="saveDeal">
        <div class="modal-scrollable overflow-y-auto max-h-96 mb-6">
          <div class="space-y-4 pr-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Deal Value</label>
              <input type="number" min="0" step="0.01" x-model.number="editDealData.deal_value" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Stage</label>
              <select x-model="editDealData.stage" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="initiated">Initiated</option>
                <option value="negotiating">Negotiating</option>
                <option value="closed">Closed</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Stage Reason</label>
              <textarea x-model="editDealData.stage_reason" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
            </div>
          </div>
        </div>
        <div class="flex justify-end space-x-2 border-t border-gray-200 pt-4">
          <button type="button" @click="closeEdit()" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <main class="p-4 sm:p-6 lg:p-8">
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Deals</h2>
      <p class="mt-1 text-sm text-gray-600">Manage your deal records</p>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center gap-2 text-sm text-gray-700">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
          <span x-text="`${filteredDeals().length} deal(s)`"></span>
        </span>
        <span class="hidden sm:inline text-gray-300">|</span>
        <span class="text-xs text-gray-500">Last updated <span x-text="lastUpdated"></span></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="exportCSV" class="px-3 py-2 text-sm rounded-md bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v8M8 9l4 4 4-4"/><path d="M4 19h16"/>
          </svg>
          Export CSV
        </button>
        <button @click="clearFilters" class="px-3 py-2 text-sm rounded-md bg-gray-100 text-gray-800 hover:bg-gray-200 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Clear filters
        </button>
        <!-- ID filter with dropdown to select id type (id, prospect_id) -->
        <div class="flex items-center space-x-2 ml-4">
          <select x-model="filterIdType" @change="onFilterChange()" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
            <option value="">ID Type</option>
            <option value="id">Deal ID</option>
            <option value="prospect_id">Prospect ID</option>
          </select>
          <input type="text" placeholder="Filter value" x-model="filterIdValue" @input="onFilterChange()" class="border border-gray-300 rounded-md px-2 py-1 text-sm"/>
        </div>
      </div>
    </div>

    <!-- Separate toggles for created_at and updated_at -->
    <div class="mb-4 flex items-center space-x-4">
      <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
        <input type="checkbox" x-model="showCreatedAt" @change="onFilterChange" class="accent-blue-600"/>
        <span>Show Created At</span>
      </label>
      <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
        <input type="checkbox" x-model="showUpdatedAt" @change="onFilterChange" class="accent-blue-600"/>
        <span>Show Updated At</span>
      </label>
    </div>

    <!-- Added stage filter grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Stage</label>
        <select x-model="filterStage" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="initiated">Initiated</option>
          <option value="negotiating">Negotiating</option>
          <option value="closed">Closed</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
      </div>
    </div>

    <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <!-- Main ID with larger font size to distinguish from other IDs -->
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('id')">
              Deal ID <span x-show="sortBy==='id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('prospect_id')">
              Prospect ID <span x-show="sortBy==='prospect_id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('deal_value')">
              Deal Value <span x-show="sortBy==='deal_value'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('stage')">
              Stage <span x-show="sortBy==='stage'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('stage_reason')">
              Stage Reason <span x-show="sortBy==='stage_reason'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th x-show="showCreatedAt" @click="toggleSort('created_at')" class="px-6 py-3 cursor-pointer text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Created At <span x-show="sortBy==='created_at'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th x-show="showUpdatedAt" @click="toggleSort('updated_at')" class="px-6 py-3 cursor-pointer text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Updated At <span x-show="sortBy==='updated_at'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-200">
          <template x-if="pagedDeals().length === 0">
            <tr>
              <td colspan="9" class="px-6 py-10 text-center">
                <div class="flex flex-col items-center gap-3">
                  <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5z"/><path d="M4 20c0-4.4 3.6-8 8-8s8 3.6 8 8"/>
                  </svg>
                  <p class="text-sm text-gray-600">No deals found</p>
                </div>
              </td>
            </tr>
          </template>

          <template x-for="deal in pagedDeals()" :key="deal.id">
            <tr class="hover:bg-gray-50">
              <!-- Main ID with larger font and bold for distinction -->
              <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900" x-text="deal.id"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="deal.prospect_id"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="`$${deal.deal_value.toFixed(2)}`"></td>

              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
                  :class="{
                    'text-blue-700': deal.stage==='initiated',
                    'text-purple-700': deal.stage==='negotiating',
                    'text-orange-700': deal.stage==='closed',
                    'text-green-700': deal.stage==='won',
                    'text-red-700': deal.stage==='lost'
                  }"
                  x-text="deal.stage">
              </td>

              <td class="px-6 py-4 max-w-xs truncate text-sm text-gray-600" :title="deal.stage_reason" x-text="deal.stage_reason || '-'"></td>

              <td x-show="showCreatedAt" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="deal.created_at"></td>
              <td x-show="showUpdatedAt" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="deal.updated_at || '-'"></td>

              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <button @click="editDeal(deal)" class="px-3 py-1.5 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">Edit</button>
                  <button @click="deleteDeal(deal)" class="px-3 py-1.5 text-xs rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition-colors">Delete</button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <div class="text-xs text-gray-500">
        Page 
        <input type="number" 
               x-model="pageInput" 
               @keydown.enter="goToPage()" 
               class="w-16 border border-gray-300 rounded px-2 py-1 text-center"/>
        of <span x-text="totalPages()"></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="page=page-1; pageInput=page+1" :disabled="page===0" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Previous</button>
        <button @click="page=page+1; pageInput=page+1" :disabled="page>=totalPages()-1" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Next</button>
      </div>
    </div>

    <!-- Success Dialog -->
    <div
      x-show="showSuccessDialog"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
    >
      <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
          </div>

          <div class="flex-1">
            <h4 class="text-sm font-semibold text-gray-900" x-text="successTitle"></h4>
            <p class="mt-1 text-sm text-gray-600" x-text="successMessage"></p>
          </div>
        </div>

        <div class="mt-4 text-right">
          <button
            @click="closeSuccess()"
            class="px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700 transition"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- DELETE CONFIRMATION DIALOG -->
    <div
      x-show="showDeleteConfirm"
      x-cloak
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
    >
      <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
        <h4 class="text-sm font-semibold text-gray-900 mb-2">Confirm Delete</h4>
        <p class="text-sm text-gray-600 mb-4">
          Are you sure you want to delete this deal?
        </p>
        <div class="flex justify-end gap-2">
          <button
            @click="cancelDelete()"
            class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300"
          >
            Cancel
          </button>
          <button
            @click="confirmDelete()"
            class="px-3 py-1.5 text-sm text-white bg-red-600 rounded hover:bg-red-700"
          >
            OK
          </button>
        </div>
      </div>
    </div>

  </main>

{% endblock %}

{% block scripts %}
<script>
function dealsPage() {
  return {
    lastUpdated: 'just now',
    showEditModal: false,
    editDealData: {},
    currentDealId: null,
    showCreatedAt: false,
    showUpdatedAt: false,
    filterIdType: '',
    filterIdValue: '',
    filterStage: '',
    sortBy: 'id',
    sortDir: 'desc',
    page: 0,
    pageSize: 10,
    deals: [],
    pageInput: null,

    /* SUCCESS DIALOG */
    showSuccessDialog: false,
    successMessage: '',
    successTitle: '',
    closeSuccess() { this.showSuccessDialog = false },

    /* DELETE CONFIRMATION */
    showDeleteConfirm: false,
    dealToDelete: null,

    clearFilters() {
      this.filterIdType = '';
      this.filterIdValue = '';
      this.filterStage = '';
    },

    init() {
      this.fetchDeals();
      this.pageInput = this.page + 1;
      if (window.GlobalPoller) {
        window.GlobalPoller.register(() => this.fetchDeals(), 15000);
      } else {
        setInterval(() => this.fetchDeals(), 15000);
      }
    },

    async fetchDeals() {
      const res = await fetch(`/crm/deals-data`);
      const data = await res.json();
      this.deals = Array.isArray(data) ? data : [];

      this.lastUpdated = new Date().toLocaleTimeString();
      this.pageInput = this.page + 1;
    },

    toggleSort(field) {
      if (this.sortBy === field) {
        this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortBy = field;
        this.sortDir = 'desc';
      }
    },

    filteredDeals() {
      let arr = [...this.deals];

      if (this.filterIdValue) {
        if (this.filterIdType === 'id') {
          arr = arr.filter(d => String(d.id).includes(this.filterIdValue));
        } else if (this.filterIdType === 'prospect_id') {
          arr = arr.filter(d => String(d.prospect_id).includes(this.filterIdValue));
        }
      }

      if (this.filterStage) arr = arr.filter(d => d.stage === this.filterStage);

      arr.sort((a, b) => {
        let av = a[this.sortBy];
        let bv = b[this.sortBy];

        if (typeof av === 'number' && typeof bv === 'number') {
          return this.sortDir === 'asc' ? av - bv : bv - av;
        }

        if (typeof av === 'string') av = av ? av.toLowerCase() : '';
        if (typeof bv === 'string') bv = bv ? bv.toLowerCase() : '';

        if (av < bv) return this.sortDir === 'asc' ? -1 : 1;
        if (av > bv) return this.sortDir === 'asc' ? 1 : -1;
        return 0;
      });

      return arr;
    },

    pagedDeals() {
      const start = this.page * this.pageSize;
      return this.filteredDeals().slice(start, start + this.pageSize);
    },

    editDeal(deal) {
      this.editDealData = { ...deal };
      this.currentDealId = deal.id;
      this.showEditModal = true;
    },

    closeEdit() {
      this.showEditModal = false;
    },

    async saveDeal() {
      const res = await fetch(`/crm/deals/${this.currentDealId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.editDealData)
      });

      const updated = await res.json();
      const idx = this.deals.findIndex(d => d.id === updated.id);
      if (idx !== -1) this.deals[idx] = updated;

      this.successTitle = 'Success';
      this.successMessage = 'Deal updated successfully.';
      this.showSuccessDialog = true;
      this.closeEdit();

      if (this.showSuccessDialog) {
        setTimeout(() => { this.showSuccessDialog = false; }, 5000);
      }
    },

    /* DELETE FLOW */
    deleteDeal(deal) {
      this.dealToDelete = deal;
      this.showDeleteConfirm = true;
    },

    cancelDelete() {
      this.showDeleteConfirm = false;
      this.dealToDelete = null;
    },

    async confirmDelete() {
      const id = this.dealToDelete.id;

      try {
        const res = await fetch(`/crm/deals/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to delete deal');
          return;
        }

        this.deals = this.deals.filter(d => d.id !== id);
        this.showDeleteConfirm = false;
        this.dealToDelete = null;

        this.successTitle = 'Success';
        this.successMessage = data.message || 'Deal deleted successfully.';
        this.showSuccessDialog = true;
        setTimeout(() => { this.showSuccessDialog = false; }, 5000);
      } catch (err) {
        alert('Network error while deleting deal');
        console.error(err);
      }
    },

    exportCSV() {
      const rows = this.filteredDeals().map(d => [
        d.id,
        d.user_id,
        d.prospect_id,
        `$${d.deal_value.toFixed(2)}`,
        d.stage,
        `"${d.stage_reason ? d.stage_reason.replace(/"/g, '""') : ''}"`,
        d.created_at,
        d.updated_at || ''
      ]);
      const csv = [['ID',  'Prospect ID', 'Deal Value', 'Stage', 'Stage Reason', 'Created At', 'Updated At'], ...rows]
        .map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'deals.csv';
      a.click();
    },

    totalPages() {
      return Math.max(1, Math.ceil(this.filteredDeals().length / this.pageSize));
    },

    goToPage() {
      const total = this.totalPages();
      let p = parseInt(this.pageInput);
      if (isNaN(p) || p < 1) p = 1;
      if (p > total) p = total;
      this.page = p - 1;
    },

    onFilterChange() {
      this.page = 0;
      this.pageInput = 1;
    }
  };
}
</script>
{% endblock %}
