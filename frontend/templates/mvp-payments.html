{% extends "template.html" %}

{% block title %}CRM System — Payments{% endblock %}

{% block x_data %}x-data="paymentsPage()" x-init="init()"{% endblock %}

{% block active_nav %}payments{% endblock %}

{% block head_extra %}
  <style>
    .modal-scrollable::-webkit-scrollbar {
      width: 8px;
    }
    .modal-scrollable::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Modal for editing payments -->
  <div x-show="editModalOpen" class="fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center" x-cloak>
    <div class="bg-white rounded-lg max-w-xl w-full p-6">
      <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 pb-4">Edit Payment</h3>
      <form @submit.prevent="saveEdit">
        <div class="modal-scrollable overflow-y-auto max-h-96 mb-6">
          <div class="space-y-4 pr-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
              <input type="number" min="0" step="0.01" x-model.number="editPaymentData.amount" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Method</label>
              <select x-model="editPaymentData.method" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="stripe">Stripe</option>
                <option value="api">API</option>
                <option value="manual">Manual</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select x-model="editPaymentData.status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
        </div>
        <div class="flex justify-end space-x-2 border-t border-gray-200 pt-4">
          <button type="button" @click="closeEdit()" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Success Dialog -->
  <div x-show="showSuccessDialog" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <div class="flex-1">
          <h4 class="text-sm font-semibold text-gray-900" x-text="successTitle"></h4>
          <p class="mt-1 text-sm text-gray-600" x-text="successMessage"></p>
        </div>
      </div>
      <div class="mt-4 text-right">
        <button @click="closeSuccess()" class="px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700 transition">OK</button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Dialog -->
  <div x-show="showDeleteConfirm" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
      <h4 class="text-sm font-semibold text-gray-900 mb-2">Confirm Delete</h4>
      <p class="text-sm text-gray-600 mb-4">Are you sure you want to delete this payment?</p>
      <div class="flex justify-end gap-2">
        <button @click="cancelDelete()" class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button @click="confirmDelete()" class="px-3 py-1.5 text-sm text-white bg-red-600 rounded hover:bg-red-700">OK</button>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <main class="p-4 sm:p-6 lg:p-8">
    <!-- Page Title -->
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Payments</h2>
      <p class="mt-1 text-sm text-gray-600">Manage your payment records</p>
    </div>

    <!-- Toolbar -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center gap-2 text-sm text-gray-700">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
          <span x-text="`${filteredPayments().length} payment(s)`"></span>
        </span>
        <span class="hidden sm:inline text-gray-300">|</span>
        <span class="text-xs text-gray-500">Last updated <span x-text="lastUpdated"></span></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="exportCSV" class="px-3 py-2 text-sm rounded-md bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v8M8 9l4 4 4-4"/><path d="M4 19h16"/>
          </svg>
          Export CSV
        </button>
        <button @click="clearFilters" class="px-3 py-2 text-sm rounded-md bg-gray-100 text-gray-800 hover:bg-gray-200 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Clear filters
        </button>
        <!-- ID filter now only filters by payment ID (no user_id) -->
        <div class="flex items-center space-x-2 ml-4">
          <input type="text" placeholder="Filter by Payment ID" x-model="filterIdValue" @input="onFilterChange" class="border border-gray-300 rounded-md px-2 py-1 text-sm"/>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Deal ID</label>
        <input type="text" placeholder="Filter by Deal ID" x-model="filterDealId" @input="onFilterChange" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Method</label>
        <select x-model="filterMethod" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All</option>
          <option value="stripe">Stripe</option>
          <option value="api">API</option>
          <option value="manual">Manual</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
        <select x-model="filterStatus" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="completed">Completed</option>
        </select>
      </div>
    </div>

    <!-- Timestamp Checkbox -->
    <div class="mb-4 flex items-center space-x-4">
      <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
        <input type="checkbox" x-model="showCreatedAt" @change="onFilterChange" class="accent-blue-600"/>
        <span>Show Created At</span>
      </label>
    </div>

    <!-- Payments Table -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="toggleSort('id')">Payment ID <span x-show="sortBy==='id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span></th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="toggleSort('deal_id')">Deal ID <span x-show="sortBy==='deal_id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span></th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="toggleSort('amount')">Amount <span x-show="sortBy==='amount'" x-text="sortDir==='asc' ? '↑' : '↓'"></span></th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="toggleSort('method')">Method <span x-show="sortBy==='method'" x-text="sortDir==='asc' ? '↑' : '↓'"></span></th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="toggleSort('status')">Status <span x-show="sortBy==='status'" x-text="sortDir==='asc' ? '↑' : '↓'"></span></th>
            <th x-show="showCreatedAt" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" @click="toggleSort('created_at')">Created At <span x-show="sortBy==='created_at'" x-text="sortDir==='asc' ? '↑' : '↓'"></span></th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Updated colspan to 7 (removed user_id and updated_at columns) -->
          <template x-if="pagedPayments().length === 0">
            <tr>
              <td colspan="7" class="px-6 py-10 text-center">
                <div class="flex flex-col items-center gap-3">
                  <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                    <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5z"/><path d="M4 20c0-4.4 3.6-8 8-8s8 3.6 8 8"/>
                  </svg>
                  <p class="text-sm text-gray-600">No payments found</p>
                </div>
              </td>
            </tr>
          </template>
          <template x-for="payment in pagedPayments()" :key="payment._key">
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="payment.id"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="payment.deal_id"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="`$${payment.amount.toFixed(2)}`"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="payment.method"></td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span :class="payment.status==='completed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'" class="px-2 py-1 rounded-full text-xs font-medium" x-text="payment.status"></span>
              </td>
              <td x-show="showCreatedAt" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="payment.created_at"></td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-2">
                  <button @click="openEdit(payment)" class="px-3 py-1.5 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors">Edit</button>
                  <button @click="deletePayment(payment)" class="px-3 py-1.5 text-xs rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition-colors">Delete</button>
                </div>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="mt-4 flex items-center justify-between">
      <div class="text-xs text-gray-500">
        Page 
        <input type="number" 
               x-model="pageInput" 
               @keydown.enter="goToPage()" 
               class="w-16 border border-gray-300 rounded px-2 py-1 text-center"/>
        of <span x-text="totalPages()"></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="page=page-1; pageInput=page+1" :disabled="page===0" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Previous</button>
        <button @click="page=page+1; pageInput=page+1" :disabled="page>=totalPages()-1" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Next</button>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
  <script>
    function paymentsPage() {
      return {
        lastUpdated: 'just now',
        showCreatedAt: false,
        filterIdValue: '',
        filterDealId: '',
        filterMethod: '',
        filterStatus: '',
        sortBy: 'id',
        sortDir: 'asc',
        page: 0,
        pageSize: 10,
        pageInput: null,
        payments: [],
        editModalOpen: false,
        editPaymentData: {},
        currentPayment: null,
        currentPaymentId: null,
        
        showSuccessDialog: false,
        successTitle: '',
        successMessage: '',
        closeSuccess() { this.showSuccessDialog = false },
        
        showDeleteConfirm: false,
        paymentToDelete: null,

        init() {
          this.fetchPayments();
          this.pageInput = this.page + 1;
          if (window.GlobalPoller) {
            window.GlobalPoller.register(() => this.fetchPayments(), 15000);
          } else {
            setInterval(() => this.fetchPayments(), 15000);
          }
        },

        async fetchPayments() {
          const res = await fetch(`/crm/payments-data`);
          const data = await res.json();
          this.payments = Array.isArray(data) ? data.map((p, i) => ({ ...p, _key: `p${p.id}${i}` })) : [];
          this.lastUpdated = new Date().toLocaleTimeString();
          this.pageInput = this.page + 1;
        },

        toggleSort(field) {
          if (this.sortBy === field) {
            this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortBy = field;
            this.sortDir = 'asc';
          }
          this.onFilterChange();
        },

        filteredPayments() {
          let arr = [...this.payments];

          if (this.filterIdValue) {
            arr = arr.filter(p => String(p.id).includes(this.filterIdValue));
          }
          if (this.filterDealId) {
            arr = arr.filter(p => String(p.deal_id).includes(this.filterDealId));
          }
          if (this.filterMethod) arr = arr.filter(p => p.method === this.filterMethod);
          if (this.filterStatus) arr = arr.filter(p => p.status === this.filterStatus);

          arr.sort((a, b) => {
            let av = a[this.sortBy], bv = b[this.sortBy];
            if (this.sortBy === 'amount') { av = Number(av); bv = Number(bv); }
            else { av = (av||'').toString().toLowerCase(); bv = (bv||'').toString().toLowerCase(); }
            return this.sortDir === 'asc' ? (av > bv ? 1 : -1) : (av < bv ? 1 : -1);
          });
          return arr;
        },

        totalPages() {
          return Math.max(1, Math.ceil(this.filteredPayments().length / this.pageSize));
        },

        pagedPayments() {
          const start = this.page * this.pageSize;
          return this.filteredPayments().slice(start, start + this.pageSize);
        },

        openEdit(payment) {
          this.currentPayment = payment;
          this.currentPaymentId = payment.id;
          this.editPaymentData = {
            amount: payment.amount,
            method: payment.method,
            status: payment.status
          };
          this.editModalOpen = true;
        },

        closeEdit() {
          this.editModalOpen = false;
        },

        async saveEdit() {
          const res = await fetch(`/crm/payments/${this.currentPaymentId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.editPaymentData)
          });

          const updated = await res.json();
          const idx = this.payments.findIndex(p => p.id === updated.id);
          if (idx !== -1) this.payments[idx] = updated;

          this.successTitle = 'Success';
          this.successMessage = 'Payment updated successfully.';
          this.showSuccessDialog = true;
          this.closeEdit();

          if (this.showSuccessDialog) {
            setTimeout(() => { this.showSuccessDialog = false; }, 5000);
          }
        },

        deletePayment(payment) {
          this.paymentToDelete = payment;
          this.showDeleteConfirm = true;
        },

        cancelDelete() {
          this.showDeleteConfirm = false;
          this.paymentToDelete = null;
        },

        async confirmDelete() {
          const id = this.paymentToDelete.id;

          try {
            const res = await fetch(`/crm/payments/${id}`, { method: 'DELETE' });
            const data = await res.json();

            if (!res.ok) {
              alert(data.error || 'Failed to delete payment');
              return;
            }

            this.payments = this.payments.filter(p => p.id !== id);
            this.showDeleteConfirm = false;
            this.paymentToDelete = null;

            this.successTitle = 'Success';
            this.successMessage = data.message || 'Payment deleted successfully.';
            this.showSuccessDialog = true;
            setTimeout(() => { this.showSuccessDialog = false; }, 5000);
          } catch (err) {
            alert('Network error while deleting payment');
            console.error(err);
          }
        },

        exportCSV() {
          const rows = this.filteredPayments();
          if (rows.length === 0) return;
          const header = ['ID', 'Deal ID', 'Amount', 'Method', 'Status', 'Created At'].join(',');
          const body = rows.map(r => [r.id, r.deal_id, r.amount, r.method, r.status, r.created_at].join(',')).join('\n');
          const csv = header + '\n' + body;
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'payments.csv';
          a.click();
          URL.revokeObjectURL(url);
        },

        clearFilters() {
          this.filterIdValue = '';
          this.filterDealId = '';
          this.filterMethod = '';
          this.filterStatus = '';
          this.page = 0;
          this.pageInput = 1;
          this.lastUpdated = 'just now';
        },

        totalPages() {
          return Math.max(1, Math.ceil(this.filteredPayments().length / this.pageSize));
        },

        goToPage() {
          const total = this.totalPages();
          let p = parseInt(this.pageInput);
          if (isNaN(p) || p < 1) p = 1;
          if (p > total) p = total;
          this.page = p - 1;
        },

        onFilterChange() {
          this.page = 0;
          this.pageInput = 1;
          this.lastUpdated = 'just now';
        }
      }
    }
  </script>
{% endblock %}
