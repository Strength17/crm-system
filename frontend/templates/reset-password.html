<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset Password — CRM System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --color-bg: #0f172a; }
    .bg-app { background: var(--color-bg); }
    .placeholder-style::placeholder {
      color: #94a3b8;
      opacity: 1;
    }
    .valid { color: #22c55e; }   /* green */
    .invalid { color: #ef4444; } /* red */
    .dialogue {
      display: none;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-weight: 600;
    }
    .dialogue.success { background-color: #22c55e; color: #fff; }
    .dialogue.error { background-color: #ef4444; color: #fff; }
  </style>
</head>
<body class="bg-app min-h-screen flex items-center justify-center px-4">

  <div class="bg-white/10 p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-md text-center">
    <!-- Dialogue Banner -->
    <div id="dialogueBox" class="dialogue"></div>

    <!-- Logo + Name -->
    <a href="{{url_for('auth.index')}}">
        <div class="flex items-center justify-center gap-3 mb-6">
          <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="w-9 h-13 " />
          <div class="text-white font-semibold text-xl">CRM System</div>
        </div>
    </a>

    <!-- Heading -->
    <h1 class="text-white text-2xl font-bold mb-2">Reset Password</h1>
    <p class="text-gray-400 mb-6 text-sm">Enter and confirm your new password</p>

    <!-- Password Input -->
    <div class="relative mb-4">
      <input type="password" id="newPassword" placeholder="New password"
        class="placeholder-style w-full px-4 py-3 text-white text-sm rounded-md bg-white/5 border border-white/20 focus:outline-none focus:border-cyan-400" />
      <svg id="newPasswordIcon" onclick="togglePassword('newPassword','newPasswordIcon')" xmlns="http://www.w3.org/2000/svg"
        fill="none" viewBox="0 0 24 24" stroke="currentColor"
        class="absolute right-3 top-3 h-5 w-5 text-gray-400 cursor-pointer">
        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path d="M2.458 12C3.732 7.943 7.523 5 12 5
                 c4.477 0 8.268 2.943 9.542 7
                 -1.274 4.057-5.065 7-9.542 7
                 -4.477 0-8.268-2.943-9.542-7z"/>
      </svg>
    </div>

    <!-- Confirm Input -->
    <div class="relative mb-4">
      <input type="password" id="confirmPassword" placeholder="Confirm password"
        class="placeholder-style w-full px-4 py-3 text-white text-sm rounded-md bg-white/5 border border-white/20 focus:outline-none focus:border-cyan-400" />
      <svg id="confirmPasswordIcon" onclick="togglePassword('confirmPassword','confirmPasswordIcon')" xmlns="http://www.w3.org/2000/svg"
        fill="none" viewBox="0 0 24 24" stroke="currentColor"
        class="absolute right-3 top-3 h-5 w-5 text-gray-400 cursor-pointer">
        <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path d="M2.458 12C3.732 7.943 7.523 5 12 5
                 c4.477 0 8.268-2.943 9.542-7
                 -1.274 4.057-5.065 7-9.542 7
                 -4.477 0-8.268-2.943-9.542-7z"/>
      </svg>
    </div>

    <!-- Password Rules -->
    <ul class="text-left text-sm space-y-1 mb-4">
      <li id="length" class="invalid">✗ At least 8 characters</li>
      <li id="uppercase" class="invalid">✗ Contains uppercase letter</li>
      <li id="lowercase" class="invalid">✗ Contains lowercase letter</li>
      <li id="digit" class="invalid">✗ Contains number</li>
      <li id="symbol" class="invalid">✗ Contains symbol</li>
      <li id="match" class="invalid">✗ Passwords match</li>
    </ul>

    <!-- Submit Button -->
    <button id="resetBtn"
      class="w-full py-3 rounded-md bg-gradient-to-r from-cyan-400 to-blue-400 text-black font-semibold hover:opacity-90 transition"
      disabled>
      Reset Password
    </button>

    <!-- Back to Login -->
    <div class="mt-6 text-sm text-gray-400">
      <a href="{{ url_for('auth.login_page') }}" class="hover:text-white">Back to Login</a>
    </div>
  </div>

  <script>
    function togglePassword(fieldId, iconId) {
      const field = document.getElementById(fieldId);
      const icon = document.getElementById(iconId);
      if (field.type === "password") {
        field.type = "text";
        icon.innerHTML = `<path d="M13.875 18.825A10.05 10.05 0 0112 19
                           c-4.477 0-8.268-2.943-9.542-7
                           a9.956 9.956 0 012.642-4.362M9.88 9.88
                           a3 3 0 104.24 4.24"/><path d="M3 3l18 18"/>`;
      } else {
        field.type = "password";
        icon.innerHTML = `<path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                          <path d="M2.458 12C3.732 7.943 7.523 5 12 5
                                   c4.477 0 8.268-2.943 9.542-7
                                   -1.274 4.057-5.065 7-9.542 7
                                   -4.477 0-8.268-2.943-9.542-7z"/>`;
      }
    }

    const passwordField = document.getElementById('newPassword');
    const confirmField = document.getElementById('confirmPassword');
    const resetBtn = document.getElementById('resetBtn');
    const dialogueBox = document.getElementById('dialogueBox');

    function validatePassword() {
      const val = passwordField.value;
      const checks = {
        length: val.length >= 8,
        uppercase: /[A-Z]/.test(val),
        lowercase: /[a-z]/.test(val),
        digit: /[0-9]/.test(val),
        symbol: /[^A-Za-z0-9]/.test(val),
        match: val && val === confirmField.value
      };
      for (let key in checks) {
        const el = document.getElementById(key);
        if (checks[key]) {
          el.classList.remove('invalid'); el.classList.add('valid'); el.textContent = "✓ " + el.textContent.slice(2);
        } else {
          el.classList.remove('valid'); el.classList.add('invalid'); el.textContent = "✗ " + el.textContent.slice(2);
        }
      }
      resetBtn.disabled = !Object.values(checks).every(Boolean);
    }

    passwordField.addEventListener('input', validatePassword);
    confirmField.addEventListener('input', validatePassword);

    function showDialogue(message, type) {
      dialogueBox.textContent = message;
      dialogueBox.className = `dialogue ${type}`;
      dialogueBox.style.display = 'block';
      setTimeout(() => {
        dialogueBox.style.display = 'none';
      }, 2500);
    }

    resetBtn.addEventListener('click', async () => {
      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");
      if (!token) {
        showDialogue("Missing reset token in URL.", "error");
        return;
      }
        try {
            const res = await fetch('/auth/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                token: token,
                password: passwordField.value
            })
            });
    
            const data = await res.json();
    
            if (res.ok) {
            showDialogue("Password reset successfully! Redirecting to login...", "success");
            setTimeout(() => {
                window.location.href = "{{ url_for('auth.login_page') }}";
            }, 3000);
            } else {
            showDialogue(data.error || "Failed to reset password.", "error");
            }
        } catch (err) {
            showDialogue("An error occurred: " + err.message, "error");
        }   
    });
  </script>