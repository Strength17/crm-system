{% extends "template.html" %}

{% block title %}CRM System — Interactions{% endblock %}

{% block x_data %}x-data="interactionsPage()" x-init="init()"{% endblock %}

{% block active_nav %}interactions{% endblock %}

{% block head_extra %}
  <style>
    .modal-scrollable::-webkit-scrollbar {
      width: 8px;
    }
    .modal-scrollable::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }
    .modal-scrollable::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Modal for editing interactions -->
  <div x-show="showEditModal" class="fixed inset-0 bg-gray-900/50 z-50 flex items-center justify-center" x-cloak>
    <div class="bg-white rounded-lg max-w-xl w-full p-6">
      <h3 class="text-xl font-semibold mb-4 border-b border-gray-200 pb-4">Edit Interaction</h3>
      <form @submit.prevent="saveInteraction">
        <div class="modal-scrollable overflow-y-auto max-h-96 mb-6">
          <div class="space-y-4 pr-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Channel</label>
              <select x-model="editInteractionData.channel" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="email">Email</option>
                <option value="phone">Phone</option>
                <option value="sms">SMS</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
              <select x-model="editInteractionData.type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="outbound">Outbound</option>
                <option value="inbound">Inbound</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Attempt Number</label>
              <input type="number" min="1" x-model.number="editInteractionData.attempt_number" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Content</label>
              <textarea x-model="editInteractionData.content" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Response Type</label>
              <select x-model="editInteractionData.response_type" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option value="opened">Opened</option>
                <option value="clicked">Clicked</option>
                <option value="replied">Replied</option>
                <option value="ignored">Ignored</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Success</label>
              <select x-model.number="editInteractionData.success" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <option :value="1">Yes</option>
                <option :value="0">No</option>
              </select>
            </div>
          </div>
        </div>
        <div class="flex justify-end space-x-2 border-t border-gray-200 pt-4">
          <button type="button" @click="closeEdit()" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <main class="p-4 sm:p-6 lg:p-8">
    <div class="mb-4">
      <h2 class="text-2xl font-bold text-gray-900">Interactions</h2>
      <p class="mt-1 text-sm text-gray-600">Manage your interaction data</p>
    </div>
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center gap-2 text-sm text-gray-700">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
          </svg>
          <span x-text="`${filteredInteractions().length} result(s)`"></span>
        </span>
        <span class="hidden sm:inline text-gray-300">|</span>
        <span class="text-xs text-gray-500">Last updated <span x-text="lastUpdated"></span></span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="exportCSV" class="px-3 py-2 text-sm rounded-md bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 5v8M8 9l4 4 4-4"/><path d="M4 19h16"/>
          </svg>
          Export CSV
        </button>
        <button @click="clearFilters" class="px-3 py-2 text-sm rounded-md bg-gray-100 text-gray-800 hover:bg-gray-200 inline-flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Clear filters
        </button>
        <div class="flex items-center space-x-2 ml-4">
          <select x-model="filterIdType" @change="onFilterChange()" class="border border-gray-300 rounded-md px-2 py-1 text-sm">
            <option value="">ID Type</option>
            <option value="id">Interaction ID</option>
            <option value="prospect_id">Prospect ID</option>
          </select>
          <input type="text" placeholder="Filter value" x-model="filterIdValue" @input="onFilterChange()" class="border border-gray-300 rounded-md px-2 py-1 text-sm"/>
        </div>
      </div>
    </div>
    <div class="mb-4 flex items-center space-x-4">
      <label class="flex items-center space-x-2 text-sm font-medium text-gray-700">
        <input type="checkbox" x-model="showCreatedAt" @change="onFilterChange" class="accent-blue-600"/>
        <span>Show Created At</span>
      </label>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Channel</label>
        <select x-model="filterChannel" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="email">Email</option>
          <option value="phone">Phone</option>
          <option value="sms">SMS</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
        <select x-model="filterType" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="outbound">Outbound</option>
          <option value="inbound">Inbound</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Response Type</label>
        <select x-model="filterResponse" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="opened">Opened</option>
          <option value="clicked">Clicked</option>
          <option value="replied">Replied</option>
          <option value="ignored">Ignored</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Success</label>
        <select x-model="filterSuccess" @change="onFilterChange" class="w-full border border-gray-300 rounded-md px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="1">Yes</option>
          <option value="0">No</option>
        </select>
      </div>
    </div>
    <div class="bg-white rounded-lg border border-gray-200 overflow-x-auto">
<table class="w-full">
  <thead class="bg-gray-50">
    <tr>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('id')">
        Interaction ID <span x-show="sortBy==='id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('prospect_id')">
        Prospect ID <span x-show="sortBy==='prospect_id'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('channel')">
        Channel <span x-show="sortBy==='channel'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('type')">
        Type <span x-show="sortBy==='type'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('attempt_number')">
        Attempt # <span x-show="sortBy==='attempt_number'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('content')">
        Content <span x-show="sortBy==='content'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('response_type')">
        Response <span x-show="sortBy==='response_type'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('success')">
        Success <span x-show="sortBy==='success'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th x-show="showCreatedAt" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" @click="toggleSort('created_at')">
        Created At <span x-show="sortBy==='created_at'" x-text="sortDir==='asc' ? '↑' : '↓'"></span>
      </th>
      <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
        Actions
      </th>
    </tr>
  </thead>

  <tbody class="bg-white divide-y divide-gray-200">
    <!-- No data -->
    <template x-if="pagedInteractions().length === 0">
      <tr>
        <td colspan="12" class="px-6 py-10 text-center">
          <div class="flex flex-col items-center gap-3">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path d="M12 12c2.7 0 5-2.3 5-5s-2.3-5-5-5-5 2.3-5 5 2.3 5 5 5z"/>
              <path d="M4 20c0-4.4 3.6-8 8-8s8 3.6 8 8"/>
            </svg>
            <p class="text-sm text-gray-600">No interactions found</p>
          </div>
        </td>
      </tr>
    </template>

    <!-- Rows -->
    <template x-for="interaction in pagedInteractions()" :key="interaction.id">
      <tr class="hover:bg-gray-50">
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium  text-gray-900" x-text="interaction.id"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="interaction.prospect_id"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="interaction.channel"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
            :class="interaction.type === 'outbound' ? 'text-green-700' : 'text-red-700'"
            x-text="interaction.type">
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="interaction.attempt_number"></td>

        <!-- Content (truncate + modal) -->
        <td class="px-6 py-4 text-sm text-gray-600 max-w-xs truncate" x-data="{ open: false }">
          <span
            class="cursor-pointer"
            :title="interaction.content"
            @click="open = true"
            x-text="interaction.content">
          </span>

          <div
            x-show="open"
            x-cloak
            @click.away="open = false"
            class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-4">
              <h4 class="text-sm font-semibold text-gray-900 mb-2">Interaction Content</h4>
              <p class="text-sm text-gray-700 whitespace-pre-wrap" x-text="interaction.content"></p>
              <div class="mt-4 text-right">
                <button
                  @click="open = false"
                  class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 rounded">
                  Close
                </button>
              </div>
            </div>
          </div>
        </td>

        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"
            :class="{
              'text-blue-700': interaction.response_type==='opened',
              'text-indigo-700': interaction.response_type==='clicked',
              'text-green-700': interaction.response_type==='replied',
              'text-gray-500': interaction.response_type==='ignored'
            }"
            x-text="interaction.response_type">
        </td>

        <td class="px-6 py-4 whitespace-nowrap">
          <span
            class="px-2 py-1 text-xs font-medium rounded-full"
            :class="interaction.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
            x-text="interaction.success ? 'Yes' : 'No'">
          </span>
        </td>

        <td x-show="showCreatedAt" class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="interaction.created_at"></td>

        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center gap-2">
            <button class="px-3 py-1.5 text-xs rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors"
                    @click="editInteraction(interaction)">
              Edit
            </button>
            <button class="px-3 py-1.5 text-xs rounded-md bg-red-50 text-red-700 hover:bg-red-100 transition-colors"
                    @click="deleteInteraction(interaction)">
              Delete
            </button>
          </div>
        </td>
      </tr>
    </template>
  </tbody>
</table>



    </div>
<div class="mt-4 flex items-center justify-between">
  <div class="text-xs text-gray-500">
    Page 
    <input type="number" 
           x-model="pageInput" 
           @keydown.enter="goToPage()" 
           class="w-16 border border-gray-300 rounded px-2 py-1 text-center"/>
    of <span x-text="totalPages()"></span>
  </div>
  <div class="flex items-center gap-2">
    <button @click="page=page-1; pageInput=page+1" :disabled="page===0" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Previous</button>
    <button @click="page=page+1; pageInput=page+1" :disabled="page>=totalPages()-1" class="px-3 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-50 disabled:opacity-50">Next</button>
  </div>
</div>

      <!-- Success Dialog -->
  <div
    x-show="showSuccessDialog"
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
  >
    <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
          </svg>
        </div>

        <div class="flex-1">
          <h4 class="text-sm font-semibold text-gray-900" x-text="successTitle"></h4>
          <p class="mt-1 text-sm text-gray-600" x-text="successMessage"></p>
        </div>
      </div>

      <div class="mt-4 text-right">
        <button
          @click="closeSuccess()"
          class="px-3 py-1.5 text-sm font-medium text-white bg-green-600 rounded hover:bg-green-700 transition"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- DELETE CONFIRMATION DIALOG -->
  <div
    x-show="showDeleteConfirm"
    x-cloak
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4"
  >
    <div class="bg-white rounded-lg max-w-sm w-full p-5 shadow-lg">
      <h4 class="text-sm font-semibold text-gray-900 mb-2">Confirm Delete</h4>
      <p class="text-sm text-gray-600 mb-4">
        Are you sure you want to delete this interaction?
      </p>
      <div class="flex justify-end gap-2">
        <button
          @click="cancelDelete()"
          class="px-3 py-1.5 text-sm bg-gray-200 rounded hover:bg-gray-300"
        >
          Cancel
        </button>
        <button
          @click="confirmDelete()"
          class="px-3 py-1.5 text-sm text-white bg-red-600 rounded hover:bg-red-700"
        >
          OK
        </button>
      </div>
    </div>
  </div>


  </main>

{% endblock %}

{% block scripts %}
<script>
function interactionsPage() {
  return {
    lastUpdated: 'just now',
    showEditModal: false,
    editInteractionData: {},
    currentInteraction: null,
    currentInteractionId: null,
    showCreatedAt: false,

    clearFilters() {
      this.filterIdType = '';
      this.filterIdValue = '';
      this.filterChannel = '';
      this.filterType = '';
      this.filterResponse = '';
      this.filterSuccess = '';
    },

    sortBy: 'id',
    sortDir: 'desc',

    page: 0,
    pageSize: 10,
    interactions: [],

    // New properties for page input
    pageInput: null, // initialize in init()

    /* SUCCESS DIALOG */
    showSuccessDialog: false,
    successMessage: '',
    closeSuccess() { this.showSuccessDialog = false },

    /* DELETE CONFIRMATION */
    showDeleteConfirm: false,
    interactionToDelete: null,

    filterIdType: '',
    filterIdValue: '',
    filterChannel: '',
    filterType: '',
    filterResponse: '',
    filterSuccess: '',

    init() {
      this.fetchInteractions();
      this.pageInput = this.page + 1; // initialize pageInput
      if (window.GlobalPoller) {
        window.GlobalPoller.register(() => this.fetchInteractions(), 15000);
      } else {
        setInterval(() => this.fetchInteractions(), 15000);
      }
    },

    async fetchInteractions() {
      const res = await fetch(`/crm/interactions-data`);
      const data = await res.json();
      this.interactions = Array.isArray(data) ? data : [];
      
      this.lastUpdated = new Date().toLocaleTimeString();

      // After fetching, sync pageInput
      this.pageInput = this.page + 1;
    },

    toggleSort(field) {
      if (this.sortBy === field) {
        this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        this.sortBy = field;
        this.sortDir = 'desc';
      }
    },

    filteredInteractions() {
      let arr = [...this.interactions];

      if (this.filterIdValue) {
        arr = arr.filter(i => String(i.id).includes(this.filterIdValue));
      }

      if (this.filterChannel) arr = arr.filter(i => i.channel === this.filterChannel);
      if (this.filterType) arr = arr.filter(i => i.type === this.filterType);
      if (this.filterResponse) arr = arr.filter(i => i.response_type === this.filterResponse);

      if (this.filterSuccess !== '') {
        const v = this.filterSuccess === '1' ? 1 : 0;
        arr = arr.filter(i => i.success === v);
      }

      arr.sort((a, b) => {
        let av = Number(a[this.sortBy]);
        let bv = Number(b[this.sortBy]);
        return this.sortDir === 'asc' ? av - bv : bv - av;
      });

      return arr;
    },

    pagedInteractions() {
      const start = this.page * this.pageSize;
      return this.filteredInteractions().slice(start, start + this.pageSize);
    },

    editInteraction(interaction) {
      this.editInteractionData = { ...interaction };
      this.currentInteractionId = interaction.id;
      this.showEditModal = true;
    },

    closeEdit() {
      this.showEditModal = false;
    },

    async saveInteraction() {
      const res = await fetch(`/crm/interactions/${this.currentInteractionId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(this.editInteractionData)
      });

      const updated = await res.json();
      const idx = this.interactions.findIndex(i => i.id === updated.id);
      if (idx !== -1) this.interactions[idx] = updated;

      this.successMessage = 'Interaction updated successfully.';
      this.showSuccessDialog = true;
      this.closeEdit();

      if (this.showSuccessDialog) {
        setTimeout(() => { this.showSuccessDialog = false; }, 5000);
      }
    },

    /* DELETE FLOW */
    deleteInteraction(interaction) {
      this.interactionToDelete = interaction;
      this.showDeleteConfirm = true;
    },

    cancelDelete() {
      this.showDeleteConfirm = false;
      this.interactionToDelete = null;
    },

    async confirmDelete() {
      const id = this.interactionToDelete.id;

      try {
        const res = await fetch(`/crm/interactions/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (!res.ok) {
          alert(data.error || 'Failed to delete interaction');
          return;
        }

        this.interactions = this.interactions.filter(i => i.id !== id);
        this.showDeleteConfirm = false;
        this.interactionToDelete = null;

        this.successMessage = data.message || 'Interaction deleted successfully.';
        this.showSuccessDialog = true;
        setTimeout(() => { this.showSuccessDialog = false; }, 5000);
      } catch (err) {
        alert('Network error while deleting interaction');
        console.error(err);
      }
    },

    exportCSV() {
      const rows = this.filteredInteractions().map(i => [
        i.id, i.prospect_id, i.channel, i.type,
        i.attempt_number, `"${i.content.replace(/"/g, '""')}"`,
        i.response_type, i.success ? 'Yes' : 'No', i.created_at
      ]);
      const csv = [['ID','Prospect ID','Channel','Type','Attempt #','Content','Response','Success','Created At'], ...rows]
        .map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'interactions.csv';
      a.click();
    },

    // New method: calculate total pages
    totalPages() {
      return Math.max(1, Math.ceil(this.filteredInteractions().length / this.pageSize));
    },

    // New method: go to page based on pageInput
    goToPage() {
      const total = this.totalPages();
      let p = parseInt(this.pageInput);
      if (isNaN(p) || p < 1) p = 1;
      if (p > total) p = total;
      this.page = p - 1;
    }
  };
}
</script>

{% endblock %}
